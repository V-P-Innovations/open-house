<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chá de Casa Nova</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Chá de Casa Nova</h1>
    
    <div id="masterSection">
        <h2>Adicionar Item à Lista</h2>
        <input type="text" id="newItem" placeholder="Nome do item" />
        <button id="addItemButton" onclick="addItem()">Adicionar</button>
        <p id="addItemFeedback" class="feedback"></p> 
    </div>

    <div id="userSection">
        <h2>Marque um Item</h2>
        <input type="text" id="userName" placeholder="Seu nome" />
        <ul id="giftList"></ul>
        <p id="userFeedback" class="feedback"></p> 
    </div>

    <script>
        async function addItem() {
            const newItem = document.getElementById('newItem').value;
            const feedback = document.getElementById('addItemFeedback');
            if (!newItem) {
                feedback.textContent = 'Por favor, insira o nome do item.';
                feedback.style.color = 'red';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/add-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newItem })
                });

                if (!response.ok) throw new Error('Erro ao adicionar o item.');

                const data = await response.json();
                document.getElementById('newItem').value = ''; 
                feedback.textContent = 'Item adicionado com sucesso!';
                feedback.style.color = 'green';

                fetchItems(); 
            } catch (error) {
                feedback.textContent = 'Falha ao adicionar o item.';
                feedback.style.color = 'red';
            }
        }

        async function fetchItems() {
            try {
                const response = await fetch('http://localhost:3000/items');
                if (!response.ok) throw new Error('Erro ao buscar itens.');
                
                const items = await response.json();
                renderItems(items);
            } catch (error) {
                document.getElementById('userFeedback').textContent = 'Erro ao carregar a lista de presentes.';
            }
        }

        function renderItems(items) {
            const giftList = document.getElementById('giftList');
            giftList.innerHTML = ''; 
            items.forEach(item => {
                const li = document.createElement('li');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `item${item.id}`;
                checkbox.disabled = item.selected_by !== null;
                checkbox.checked = item.selected_by !== null;
                checkbox.addEventListener('change', () => selectItem(item.id));

                const label = document.createElement('label');
                label.htmlFor = `item${item.id}`;
                label.textContent = `${item.name} - ${item.selected_by ? 'Escolhido por: ' + item.selected_by : ''}`;

                li.appendChild(checkbox);
                li.appendChild(label);
                giftList.appendChild(li);
            });
        }

        async function selectItem(id) {
            const userName = document.getElementById('userName').value;
            const userFeedback = document.getElementById('userFeedback');
            if (!userName) {
                userFeedback.textContent = 'Por favor, insira seu nome antes de escolher um item.';
                userFeedback.style.color = 'red';
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/select-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, selectedBy: userName })
                });

                if (!response.ok) throw new Error('Erro ao selecionar o item.');

                fetchItems(); 
                userFeedback.textContent = 'Item selecionado com sucesso!';
                userFeedback.style.color = 'green';
            } catch (error) {
                userFeedback.textContent = 'Falha ao selecionar o item.';
                userFeedback.style.color = 'red';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchItems);
    </script>
</body>
</html>
